name: Terraform Infrastructure

on:
  push:
    branches: [ main ]
    paths:
      - 'terraform/**'
      - '.github/workflows/tf-deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'terraform/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - destroy

permissions:
  id-token: write
  contents: read

env:
  AZURE_RESOURCE_GROUP: rg-kubeopt-com
  AZURE_CLUSTER_NAME: aks-kubeopt-com

jobs:
  # Plan Terraform Changes (No approval needed)
  terraform-plan:
    runs-on: ubuntu-latest
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
      plan_output: ${{ steps.plan.outputs.stdout }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
        terraform_wrapper: false

    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: Terraform Validate
      working-directory: ./terraform
      run: terraform validate

    - name: Terraform Plan
      id: plan
      working-directory: ./terraform
      run: |
        terraform plan -detailed-exitcode -var="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" -no-color -out=tfplan
        echo "exitcode=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Upload Plan
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan
        path: terraform/tfplan
        retention-days: 5

    - name: Comment PR with Plan
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const output = `
          ## ğŸ—ï¸ Terraform Infrastructure Plan
          
          **Plan Status:** ${{ steps.plan.outputs.exitcode == '0' && 'âœ… No changes' || steps.plan.outputs.exitcode == '1' && 'âŒ Error' || 'ğŸ“ Changes detected' }}
          
          <details>
          <summary>Show Plan Details</summary>
          
          \`\`\`terraform
          ${{ steps.plan.outputs.stdout }}
          \`\`\`
          
          </details>
          
          **ğŸ’° Estimated Monthly Cost:** $25-35
          **ğŸ“‹ Resources:** AKS Cluster, Container Registry, Budget Alerts
          
          *Infrastructure changes require approval in tf-prod environment*
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })

  # Apply Infrastructure (Requires tf-prod approval)
  terraform-apply:
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
    environment: tf-prod  # ğŸ”’ APPROVAL REQUIRED FOR INFRASTRUCTURE
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0

    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: Download Plan (if available)
      if: needs.terraform-plan.outputs.plan_exitcode == '2'
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan
        path: terraform/

    - name: Terraform Apply
      working-directory: ./terraform
      run: |
        if [ -f "tfplan" ]; then
          echo "ğŸš€ Applying saved plan..."
          terraform apply tfplan
        else
          echo "ğŸš€ Applying with auto-approve..."
          terraform apply -auto-approve -var="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}"
        fi

    - name: Infrastructure Status
      run: |
        echo "ğŸ—ï¸ Infrastructure deployment completed"
        echo "ğŸ“Š Estimated monthly cost: $25-35"
        echo ""
        echo "ğŸ” Deployed resources:"
        az resource list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --output table || echo "Resource group not ready yet"
        
        echo ""
        echo "âš™ï¸ AKS Cluster Status:"
        az aks show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_CLUSTER_NAME }} \
          --query "{status: provisioningState, version: currentKubernetesVersion, nodeCount: agentPoolProfiles[0].count}" \
          --output table || echo "AKS not ready yet"

    - name: Cost Monitoring Setup
      run: |
        echo "ğŸ’° Cost monitoring configured:"
        echo "â€¢ Monthly budget: $50"
        echo "â€¢ Alert at 80%: $40"
        echo "â€¢ Forecast alert at 90%: $45"
        echo "â€¢ Budget notifications enabled"

  # Destroy Infrastructure (Requires tf-prod approval)
  terraform-destroy:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    environment: tf-prod  # ğŸ”’ APPROVAL REQUIRED FOR DESTRUCTION
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0

    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: Terraform Destroy
      working-directory: ./terraform
      run: |
        echo "ğŸ”¥ Destroying infrastructure..."
        echo "âš ï¸ This will delete:"
        echo "  â€¢ AKS Cluster"
        echo "  â€¢ Container Registry" 
        echo "  â€¢ Public IP"
        echo "  â€¢ Budget alerts"
        echo ""
        terraform destroy -auto-approve -var="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}"
        echo ""
        echo "âœ… Infrastructure destroyed"
        echo "ğŸ’° Monthly savings: ~$30-35 (only backend storage remains)"